name: üéØ Allure Report for Java Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v3
      
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: üîß Setup Maven
      uses: stCarolas/setup-maven@v4
      with:
        maven-version: '3.8.4'
        
    - name: üì¶ Install dependencies and run tests with Allure
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π Maven –ø—Ä–æ–µ–∫—Ç –µ—Å–ª–∏ –Ω–µ—Ç pom.xml
        if [ ! -f pom.xml ]; then
          cat > pom.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <project xmlns="http://maven.apache.org/POM/4.0.0"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            
            <groupId>com.petstore</groupId>
            <artifactId>petstore-api-tests</artifactId>
            <version>1.0-SNAPSHOT</version>
            
            <properties>
                <maven.compiler.source>11</maven.compiler.source>
                <maven.compiler.target>11</maven.compiler.target>
                <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
            </properties>
            
            <dependencies>
                <dependency>
                    <groupId>org.testng</groupId>
                    <artifactId>testng</artifactId>
                    <version>7.7.0</version>
                </dependency>
                <dependency>
                    <groupId>io.rest-assured</groupId>
                    <artifactId>rest-assured</artifactId>
                    <version>5.3.0</version>
                </dependency>
                <dependency>
                    <groupId>io.qameta.allure</groupId>
                    <artifactId>allure-testng</artifactId>
                    <version>2.21.0</version>
                </dependency>
            </dependencies>
            
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-surefire-plugin</artifactId>
                        <version>3.0.0-M9</version>
                        <configuration>
                            <argLine>-javaagent:${settings.localRepository}/org/aspectj/aspectjweaver/1.9.19/aspectjweaver-1.9.19.jar</argLine>
                            <properties>
                                <property>
                                    <name>allure.results.directory</name>
                                    <value>${project.build.directory}/allure-results</value>
                                </property>
                            </properties>
                        </configuration>
                        <dependencies>
                            <dependency>
                                <groupId>org.aspectj</groupId>
                                <artifactId>aspectjweaver</artifactId>
                                <version>1.9.19</version>
                            </dependency>
                        </dependencies>
                    </plugin>
                </plugins>
            </build>
        </project>
        EOF
        fi
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ç–≤–æ–∏ —Ç–µ—Å—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Maven
        mkdir -p src/test/java
        cp src/PetStoreTest.java src/test/java/
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å Allure
        mvn test
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã Allure
        cp -r target/allure-results ./allure-results || echo "No Allure results found"
        
    - name: üß™ Run backup Python tests (–µ—Å–ª–∏ Java —Ç–µ—Å—Ç—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—é—Ç)
      run: |
        pip install requests
        python -c "
        import requests
        import json
        r = requests.get('https://petstore.swagger.io/v2/pet/findByStatus?status=available')
        print(f'API Status: {r.status_code}')
        with open('allure-results/result.json', 'w') as f:
            json.dump({'name': 'API Check', 'status': 'passed' if r.status_code == 200 else 'failed'}, f)
        "
        
    - name: üìä Publish Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_report: allure-report
        keep_reports: 20
