name: Allure Report

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests pytest allure-pytest

      - name: Create test file
        run: |
          mkdir -p tests
          cat > tests/test_api.py << 'EOF'
import requests
import allure

@allure.title("PetStore API Test")
def test_petstore_api():
    response = requests.get("https://petstore.swagger.io/v2/pet/findByStatus?status=available")
    assert response.status_code == 200
EOF

      - name: Run tests with Allure
        run: pytest tests/ --alluredir=allure-results -v

      - name: Generate Allure Report
        run: |
          wget https://repo1.maven.org/maven2/io/qameta/allure/allure-commandline/2.26.0/allure-commandline-2.26.0.zip
          unzip allure-commandline-2.26.0.zip -d allure
          export PATH=$PATH:$(pwd)/allure/allure-2.26.0/bin
          allure generate allure-results -o allure-report --clean

      - name: Add .nojekyll file
        run: touch allure-report/.nojekyll

      - name: Deploy to GitHub Pages
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git checkout -b gh-pages || git checkout gh-pages
          rm -rf ./*
          cp -r allure-report/* .
          touch .nojekyll
          git add .
          git commit -m "Update Allure report" || echo "No changes to commit"
          git push origin gh-pages
