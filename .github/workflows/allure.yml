name: ğŸš€ Allure Report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests==2.31.0
        pip install pytest==7.4.0
        pip install allure-pytest==2.13.2
        pip install pytest-html==4.1.1
        
    - name: ğŸ§ª Create test files
      run: |
        mkdir -p tests
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ __init__.py
        echo "# Test package" > tests/__init__.py
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ conftest.py
        cat > tests/conftest.py << "CONFEOF"
import pytest
import requests

@pytest.fixture
def base_url():
    return "https://petstore.swagger.io/v2"
    
@pytest.fixture
def session():
    return requests.Session()
CONFEOF

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ test_pet_api.py
        cat > tests/test_pet_api.py << "PETEOF"
import requests
import allure
import pytest
import json
from datetime import datetime

BASE_URL = "https://petstore.swagger.io/v2"

@allure.epic("PetStore API")
@allure.feature("Pet Management")
class TestPetAPI:
    
    @pytest.fixture
    def pet_data(self):
        return {
            "id": int(datetime.now().timestamp()),
            "category": {"id": 1, "name": "Dogs"},
            "name": "TestDog",
            "photoUrls": ["https://example.com/photo.jpg"],
            "tags": [{"id": 1, "name": "friendly"}],
            "status": "available"
        }
    
    @allure.title("Add new pet to the store")
    @allure.severity(allure.severity_level.BLOCKER)
    def test_add_new_pet(self, pet_data):
        with allure.step("Prepare request data"):
            allure.attach(json.dumps(pet_data, indent=2), name="Request Body", attachment_type=allure.attachment_type.JSON)
        
        with allure.step("Send POST request to /pet"):
            start_time = datetime.now()
            response = requests.post(f"{BASE_URL}/pet", json=pet_data)
            response_time = (datetime.now() - start_time).total_seconds()
            
        with allure.step("Verify response"):
            assert response.status_code == 200, f"Expected 200, got {response.status_code}"
            response_json = response.json()
            allure.attach(json.dumps(response_json, indent=2), name="Response Body", attachment_type=allure.attachment_type.JSON)
            allure.attach(f"Response time: {response_time:.2f}s", name="Performance", attachment_type=allure.attachment_type.TEXT)
            
            assert response_json["id"] == pet_data["id"]
            assert response_json["name"] == pet_data["name"]
            assert response_json["status"] == pet_data["status"]
    
    @allure.title("Find pet by ID")
    @allure.severity(allure.severity_level.CRITICAL)
    def test_find_pet_by_id(self, pet_data):
        # First create a pet
        create_response = requests.post(f"{BASE_URL}/pet", json=pet_data)
        pet_id = pet_data["id"]
        
        with allure.step(f"Search for pet with ID {pet_id}"):
            response = requests.get(f"{BASE_URL}/pet/{pet_id}")
            
        with allure.step("Verify pet found"):
            if response.status_code == 200:
                pet_info = response.json()
                allure.attach(f"Found pet: {pet_info['name']} (ID: {pet_info['id']})", name="Pet Info", attachment_type=allure.attachment_type.TEXT)
                assert pet_info["id"] == pet_id
            # 404 is also acceptable if pet was deleted
    
    @allure.title("Find pets by status")
    @allure.severity(allure.severity_level.NORMAL)
    def test_find_pets_by_status(self):
        statuses = ["available", "pending", "sold"]
        
        for status in statuses:
            with allure.step(f"Search pets with status: {status}"):
                response = requests.get(f"{BASE_URL}/pet/findByStatus?status={status}")
                assert response.status_code == 200
                pets = response.json()
                allure.attach(f"Found {len(pets)} pets with status: {status}", name=f"Status {status}", attachment_type=allure.attachment_type.TEXT)
PETEOF

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ test_store_api.py
        cat > tests/test_store_api.py << "STOREEOF"
import requests
import allure
import json

BASE_URL = "https://petstore.swagger.io/v2"

@allure.epic("PetStore API")
@allure.feature("Store Management")
class TestStoreAPI:
    
    @allure.title("Get store inventory")
    @allure.severity(allure.severity_level.NORMAL)
    def test_get_inventory(self):
        with allure.step("Request inventory data"):
            response = requests.get(f"{BASE_URL}/store/inventory")
            
        with allure.step("Verify inventory response"):
            assert response.status_code == 200
            inventory = response.json()
            allure.attach(json.dumps(inventory, indent=2), name="Inventory", attachment_type=allure.attachment_type.JSON)
            assert isinstance(inventory, dict)
    
    @allure.title("Place order for pet")
    @allure.severity(allure.severity_level.CRITICAL)
    def test_place_order(self):
        order_data = {
            "id": 1,
            "petId": 123,
            "quantity": 1,
            "shipDate": "2023-12-20T10:00:00.000Z",
            "status": "placed",
            "complete": True
        }
        
        with allure.step("Place new order"):
            response = requests.post(f"{BASE_URL}/store/order", json=order_data)
            
        with allure.step("Verify order placed"):
            assert response.status_code == 200
            order_response = response.json()
            allure.attach(json.dumps(order_response, indent=2), name="Order Response", attachment_type=allure.attachment_type.JSON)
STOREEOF

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ test_user_api.py
        cat > tests/test_user_api.py << "USEREOF"
import requests
import allure
import json

BASE_URL = "https://petstore.swagger.io/v2"

@allure.epic("PetStore API") 
@allure.feature("User Management")
class TestUserAPI:
    
    @allure.title("Check user login functionality")
    @allure.severity(allure.severity_level.MINOR)
    def test_user_login(self):
        with allure.step("Attempt user login"):
            response = requests.get(f"{BASE_URL}/user/login?username=test&password=test")
            # Can return 200 or 400 depending on user existence
            assert response.status_code in [200, 400]
    
    @allure.title("Check user logout functionality")
    @allure.severity(allure.severity_level.MINOR)
    def test_user_logout(self):
        with allure.step("Attempt user logout"):
            response = requests.get(f"{BASE_URL}/user/logout")
            assert response.status_code == 200
USEREOF
        
    - name: ğŸ§ª Run tests with Allure
      run: |
        echo "=== Running PetStore API Tests ==="
        pytest tests/ -v --alluredir=allure-results
        
    - name: ğŸ“Š Generate Allure report
      run: |
        echo "=== Generating Allure Report ==="
        allure generate allure-results --clean -o allure-report
        
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./allure-report
        force_orphan: true
